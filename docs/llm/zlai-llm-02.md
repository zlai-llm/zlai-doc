# å¤§æ¨¡å‹è°ƒç”¨å…¶ä»–æ–¹æ³•

> è¿™é‡Œå±•ç¤ºçš„æ¨¡å‹æ–¹æ³•é€‚ç”¨äº`zlai`å°è£…çš„å…¨éƒ¨åœ¨çº¿å¤§æ¨¡å‹æˆ–æœ¬åœ°å¤§æ¨¡å‹ï¼Œä½†ç”±äºç¯‡å¹…æ‰€é™è¿™é‡Œä»…ä»¥`æ™ºè°±AI`çš„`ZhipuGLM3Turbo`ä½œä¸ºç¤ºä¾‹ã€‚

## æ¨¡å‹è¾“å‡ºæ•°æ®ç±»å‹

ä¸Šä¸€èŠ‚å·²ç»ç®€å•ä»‹ç»äº†æ¨¡å‹çš„å›ç­”è¾“å‡ºæ•°æ®ç±»å‹ï¼Œè¿™é‡Œå†ç®€å•æ€»ç»“ä¸€ä¸‹ã€‚

### å…¨é‡`Completion`

> é»˜è®¤æƒ…å†µä¸‹ï¼Œå…¨é‡è¾“å‡º`completion`ä¿¡æ¯

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo

llm = Zhipu(generate_config=ZhipuGLM3Turbo())
completion = llm.generate(query="ä½ å¥½")
print(completion)
```

> è¾“å‡º`Completion`ç»“æœ

```text
model='glm-3-turbo' created=1714271348 choices=[CompletionChoice(index=0, finish_reason='stop', message=CompletionMessage(content='ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚', role='assistant', tool_calls=None))] request_id='8605594695711311367' id='8605594695711311367' usage=CompletionUsage(prompt_tokens=6, completion_tokens=30, total_tokens=36)
```

### è¿”å›æ¶ˆæ¯`Message`

> æŒ‡å®š`output="message"`ï¼Œè¿”å›`Message`æ¶ˆæ¯

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo

llm = Zhipu(
    output="message",                # ä»¥messageæ¶ˆæ¯å½¢å¼è¾“å‡º
    generate_config=ZhipuGLM3Turbo()
)
message = llm.generate(query="ä½ å¥½")
print(message)
```

> è¾“å‡ºç»“æœ

```text
content='ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚' role='assistant' tool_calls=None
```

**Tips**: *`tool_calls`æ˜¯`function call`æ¨¡å¼ä¸‹æ¨¡å‹è°ƒç”¨ä¿¡æ¯ï¼Œè¿™é‡Œå…ˆä¸åšä»‹ç»ï¼Œåœ¨åç»­çš„`Agent`éƒ¨åˆ†å°†ä¼šåšè¯¦ç»†çš„ä»‹ç»ã€‚*

### ä»…è¿”å›å›ç­”çš„æ–‡æœ¬ä¿¡æ¯

> æŒ‡å®š`output="str"`ï¼Œè¿”å›å›ç­”çš„æ–‡æœ¬ä¿¡æ¯

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo

llm = Zhipu(
    output="str",                    # ä»¥strå½¢å¼è¾“å‡º
    generate_config=ZhipuGLM3Turbo()
)
content = llm.generate(query="ä½ å¥½")
print(content)
```

> è¾“å‡ºç»“æœ

```text
ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚
```

## ä¸åŒçš„æ¨¡å‹å›ç­”ç”Ÿæˆæ–¹å¼`Generate`

> æœ¬å°èŠ‚ä»‹ç»`zlai`ä¸­ä¸åŒçš„ç”Ÿæˆå›ç­”æ–¹å¼åŠå…¶é€‚ç”¨çš„åœºæ™¯ï¼Œå¹¶å±•ç¤ºå¦‚ä½•ä½¿ç”¨è¿™äº›æ–¹å¼ã€‚

### `Query`æ¨ç†

`Query`æ¨ç†çš„æ–¹å¼æ˜¯ç›´æ¥æŒ‡å®šä¸€ä¸ª`query`é—®é¢˜å‚æ•°ï¼Œç„¶åæ¨¡å‹ä¼šæ ¹æ®è¿™ä¸ª`query`ç”Ÿæˆå›ç­”ã€‚æ¨¡å‹ä¼šåœ¨å®Œæˆå…¨éƒ¨çš„æ¨¡å‹æ¨ç†åè¿”å›æœ€ç»ˆçš„å›ç­”ã€‚

> ä»£ç ç¤ºä¾‹

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo
# åˆ›å»ºå¤§æ¨¡å‹
llm = Zhipu(generate_config=ZhipuGLM3Turbo())
completion = llm.generate(query="ä½ å¥½")

print(completion.choices[0].message.content)
```

> å›ç­”è¾“å‡º

```text
ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚
```

### `Message`æ¨ç†

`Message`æ¨ç†çš„æ–¹å¼æ˜¯æŒ‡å®šä¸€ä¸ª`Message`çš„`List`çš„å½¢å¼(`List[Message]`)æ¨¡å‹ä¼šæ ¹æ®å¤šä¸ªæ¶ˆæ¯ï¼ˆ`Message`ï¼‰è¿›è¡Œé—®é¢˜çš„å›ç­”ã€‚æ¨¡å‹ä¼šåœ¨å®Œæˆå…¨éƒ¨çš„æ¨¡å‹æ¨ç†åè¿”å›æœ€ç»ˆçš„å›ç­”ã€‚

`Message`çš„ä¸€èˆ¬åŒ…å«ä¸¤ä¸ªå†…å®¹`role`å’Œ`content`ï¼š

- è§’è‰²`role`: å¯¹è¯çš„è§’è‰²ï¼Œä¸€èˆ¬åŒ…å«ç”¨æˆ·è§’è‰²`user`ã€AIè§’è‰²`Assistant`ã€ç³»ç»Ÿè§’è‰²`System`ã€‚
  - ç”¨æˆ·è§’è‰²`user`: æŒ‡çš„æ˜¯ç”¨æˆ·ï¼Œä¸€èˆ¬ç”±ç”¨æˆ·æå‡ºé—®é¢˜ã€‚
  - AIè§’è‰²`Assistant`: æŒ‡çš„æ˜¯AIåŠ©æ‰‹ï¼Œä¸€èˆ¬ç”±AIåŠ©æ‰‹å›ç­”é—®é¢˜ã€‚
  - ç³»ç»Ÿè§’è‰²`System`: æŒ‡çš„æ˜¯ç³»ç»Ÿï¼Œä¸€èˆ¬æ˜¯`List[Message]`çš„ç¬¬ä¸€æ¡ä¿¡æ¯æ˜¯æä¾›ç»™å¤§æ¨¡å‹çš„ç³»ç»Ÿæ¶ˆæ¯å†…å®¹ã€‚
- å†…å®¹`content`: å¯¹è¯çš„å†…å®¹ï¼Œä¸€èˆ¬æ˜¯`str`æ ¼å¼çš„æ–‡æœ¬æ•°æ®ã€‚

> å¦‚ä½•æŒ‡å®š`Message`ï¼Ÿ

åœ¨`zlai`ä¸­æ‚¨å¯ä»¥æ–¹ä¾¿çš„ç»„ç»‡`Message`ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```python
from zlai.schema import SystemMessage, UserMessage, AssistantMessage

messages = [
    SystemMessage(content="ä½ æ˜¯ä¸€ä¸ªäººå·¥æ™ºèƒ½åŠ©æ‰‹"),
    UserMessage(content="ä½ å¥½"),
    AssistantMessage(content="ä½ å¥½ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚"),
    UserMessage(content="ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ"),
    ...,
]
```

å…¶ä¸­ï¼Œ

- `SystemMessage`: ç”¨äºæŒ‡å®šç³»ç»Ÿæ¶ˆæ¯ã€‚
- `UserMessage`: ç”¨äºæŒ‡å®šç”¨æˆ·æ¶ˆæ¯ã€‚
- `AssistantMessage`: ç”¨äºæŒ‡å®šAIåŠ©æ‰‹æ¶ˆæ¯ã€‚
- `Message`: æ˜¯ä»¥ä¸Šä¸‰ä¸ªæ¶ˆæ¯çš„çˆ¶ç±»ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨`Message`æ¥æŒ‡å®šä»»æ„ç±»å‹çš„æ¶ˆæ¯ã€‚ä¸‹é¢æ˜¯ä¸ªä¾‹å­:

```python
from zlai.schema import Message

messages = [
    Message(role="system", content="ä½ æ˜¯ä¸€ä¸ªäººå·¥æ™ºèƒ½åŠ©æ‰‹"),
    Message(role="user", content="ä½ å¥½"),
    Message(role="assistant", content="ä½ å¥½ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚"),
    Message(role="user", content="ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ"),
]
```

> åœ¨æ„é€ äº†`Messages`åï¼Œå¦‚ä½•è¿›è¡Œ`Message`æ¨ç†ï¼Ÿ

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo
from zlai.schema import SystemMessage, UserMessage, AssistantMessage

# åˆ›å»ºå¤§æ¨¡å‹
llm = Zhipu(generate_config=ZhipuGLM3Turbo())

messages = [
    SystemMessage(content="ä½ æ˜¯ä¸€ä¸ªäººå·¥æ™ºèƒ½åŠ©æ‰‹"),
    UserMessage(content="ä½ å¥½"),
    AssistantMessage(content="ä½ å¥½ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚"),
    UserMessage(content="ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ"),
]

completion = llm.generate(messages=messages)

print(completion.choices[0].message.content)
```

```text
æˆ‘æ˜¯ä¸€ä¸ªäººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œæˆ‘çš„åå­—æ˜¯æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ã€‚
```

**Tips**: *æˆ‘ä»¬æ¨èæ‚¨æ›´å¤šçš„ä½¿ç”¨*Message*çš„æ¨ç†æ–¹å¼ï¼Œè¿™å¯ä»¥ä¸ºæ‚¨æ–¹ä¾¿çš„ç»„ç»‡å†å²æ¶ˆæ¯ä¿¡æ¯ï¼Œæ„é€ æ›´ä¸ºçµæ´»çš„é—®ç­”æœºåˆ¶ã€‚ä»¥ä¸Šä»…æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œåœ¨åé¢çš„ä»‹ç»ä¸­æˆ‘ä»¬å°†ä»‹ç»æ›´ä¸ºå¤æ‚çš„`messages`çš„ç»„ç»‡é€»è¾‘ã€‚*

### `Stream`æ¨ç†

`stream`æ¨ç†æ˜¯ä¸€ç§é€å—è¿”å›å›ç­”å†…å®¹çš„æ–¹å¼ï¼Œèƒ½å¤Ÿå®ç°ç±»ä¼¼æ‰“å­—æœºçš„æ•ˆæœï¼Œæ„å»ºèŠå¤©ç¨‹åºçš„æ—¶å€™å¸¸ç”¨ï¼Œèƒ½å¤Ÿç»™ä½¿ç”¨è€…æ›´ä¸ºå¿«æ·çš„æ¶ˆæ¯åé¦ˆï¼Œæœ‰æ›´å¥½çš„ä½¿ç”¨ä½“éªŒã€‚

åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæ‚¨åªéœ€è¦åœ¨æ¨¡å‹é…ç½®ç±»ä¸­æŒ‡å®š`stream=True`å³å¯ï¼Œå…¶ä»–å‚æ•°ä¸ä¸Šæ–‡çš„å†…å®¹å¹¶æ— åŒºåˆ«ã€‚

> ä½¿ç”¨ç¤ºä¾‹

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo
from zlai.schema import UserMessage

# åˆ›å»ºæ¨¡å‹æ¨ç†é…ç½®ï¼Œå¹¶æŒ‡å®šstream=True
generate_config = ZhipuGLM3Turbo(stream=True)

# åˆ›å»ºå¤§æ¨¡å‹
llm = Zhipu(generate_config=generate_config)
messages = [UserMessage(content="ä½ å¥½")]
responses = llm.generate(messages=messages)

answer = ''
for response in responses:
    answer += response.choices[0].delta.content
    print(answer, end='\n\n')
```

**Tips**: *åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†æ¯æ¬¡å›ç­”çš„è¾“å‡º`delta`æ‹¼æ¥åˆ°`answer`å›ç­”ä¸­ï¼Œå¹¶é€è¡Œè¿›è¡Œäº†æ‰“å°ã€‚ä¸‹é¢æ˜¯è¾“å‡ºç»“æœã€‚*

> å›ç­”è¾“å‡º

```text
ä½ å¥½

ä½ å¥½ğŸ‘‹ï¼

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™º

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆ

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆC

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChat

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGL

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLM

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œ

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ 

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œ

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚

ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹æ™ºè°±æ¸…è¨€ï¼ˆChatGLMï¼‰ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚
```



----

## è¾“å‡ºç»“æœçš„è§£æ

ä¸ºäº†æ–¹ä¾¿è¾“å‡ºå†…å®¹çš„ç»“æ„åŒ–ï¼Œ`zlai`å°è£…çš„å¤§æ¨¡å‹éƒ½æ”¯æŒå¯¹æ¨¡å‹è¾“å‡ºçš„ç»“æœè¿›è¡Œè§£æï¼Œè§£æçš„ç»“æœå¯ä»¥ä»¥`dict/list/script`çš„å½¢å¼è¿”å›ã€‚è¿™æ ·çš„è®¾è®¡å¯ä»¥ä¸ºåç»­çš„æ–‡æœ¬æ•°æ®è§£æä»¥åŠä»å›ç­”å†…å®¹ä¸­è§£æå‡ºç¨‹åºä»£ç `script`æä¾›æ–¹ä¾¿ã€‚

ä½¿ç”¨`generate_with_parse`æ–¹æ³•ï¼Œå¯ä»¥å®ç°å¯¹äºæ¨¡å‹è¾“å‡ºç»“æœçš„è§£æã€‚

> `generate_with_parse`å‚æ•°è¯´æ˜

| å‚æ•°å          | å‚æ•°ç±»å‹          | å‚æ•°è¯´æ˜                                                                                                                               |
|--------------|---------------|------------------------------------------------------------------------------------------------------------------------------------|
| `query`      | str           | éœ€è¦å¤§æ¨¡å‹å›ç­”çš„é—®é¢˜ï¼Œä¸`messages`äºŒé€‰ä¸€ç»™å®šå³å¯                                                                                                      |
| `messages`   | List[Message] | æ¶ˆæ¯ï¼Œä¸`query`äºŒé€‰ä¸€ç»™å®šå³å¯                                                                                                                 |
| `parse_fun`  | Callable      | è‡ªå®šä¹‰çš„è§£æå‡½æ•°ï¼Œä¸ä¸‹é¢`parse_dict`äºŒé€‰ä¸€ç»™å®šå³å¯                                                                                                    |
| `parse_dict` | Literal[str]  | æšä¸¾å€¼ï¼Œæœ‰ä¸‰ä¸ªå€¼å¯ä»¥ç»™å®š`["eval", "greedy", "nested"]`, `eval`é€‚ç”¨äºè¾“å‡ºå†…å®¹ä¸­åªæœ‰ä¸€ä¸ª`Dict`çš„æƒ…å†µï¼›`greedy`é€‚ç”¨äºè¾“å‡ºå†…å®¹ä¸­æœ‰å¤šä¸ª`Dict`çš„æƒ…å†µï¼›`nested`é€‚ç”¨äºè¾“å‡ºå†…å®¹ä¸­æœ‰åµŒå¥—`Dict`çš„æƒ…å†µï¼› |

> ä½¿ç”¨æ–¹å¼-1: ç»™å®š`parse_dict`

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo

llm = Zhipu(generate_config=ZhipuGLM3Turbo())

question = """
æ–‡æœ¬ï¼šå¼ ä¸‰åœ¨æ­å·åƒäº†ä¸€ç¬¼å°ç¬¼åŒ…ã€‚
é—®é¢˜ï¼šè¯·è§£æå‡ºæ–‡æœ¬ä¸­çš„äººåã€åœ°ç‚¹ï¼Œä»¥Dictçš„æ ¼å¼è¾“å‡ºã€‚
æ ¼å¼ç¤ºä¾‹ï¼š{'name': ..., 'place': ...,}
ä½ åªéœ€è¦è¾“å‡ºè§£æåçš„Dictï¼Œä¸éœ€è¦è¾“å‡ºå…¶ä»–å†…å®¹ã€‚"""

output = llm.generate_with_parse(query=question, parse_dict='eval',)

print(llm.parse_info)
print(f"è§£æåæ•°æ®ç±»å‹: {type(output[0])}")
print(f"è§£æç»“æœ: {output[0]}")
```

> è¾“å‡ºç»“æœ

```text
[ParseInfo(content="{'name': 'å¼ ä¸‰', 'place': 'æ­å·'}", parsed_data=[{'name': 'å¼ ä¸‰', 'place': 'æ­å·'}], error_message=None)]
è§£æåæ•°æ®ç±»å‹: <class 'dict'>
è§£æç»“æœ: {'name': 'å¼ ä¸‰', 'place': 'æ­å·'}
```

å…¶ä¸­ï¼Œ`llm.parse_info`ä¸­å­˜å‚¨äº†è§£æçš„å†å²ä¿¡æ¯ï¼Œ`content`æ˜¯æ¨¡å‹å›ç­”è¾“å‡ºçš„å†…å®¹æ•°æ®ç±»å‹ä¸º`str`ï¼Œ`parsed_data`æ˜¯è§£æåçš„æ•°æ®ï¼Œ`error_message`æ˜¯è§£æé”™è¯¯çš„ä¿¡æ¯ï¼Œå¦‚æœè§£ææ­£ç¡®åˆ™ä¸º`None`ã€‚

> ä½¿ç”¨æ–¹å¼-2: è‡ªå®šä¹‰è§£æå‡½æ•°ã€‚

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo

def udf_parse(string):
  """è‡ªå®šä¹‰è§£æå‡½æ•°"""
  return eval(string)

llm = Zhipu(generate_config=ZhipuGLM3Turbo())

question = """
æ–‡æœ¬ï¼šå¼ ä¸‰åœ¨æ­å·åƒäº†ä¸€ç¬¼å°ç¬¼åŒ…ã€‚
é—®é¢˜ï¼šè¯·è§£æå‡ºæ–‡æœ¬ä¸­çš„äººåã€åœ°ç‚¹ï¼Œä»¥Dictçš„æ ¼å¼è¾“å‡ºã€‚
æ ¼å¼ç¤ºä¾‹ï¼š{'name': ..., 'place': ...,}
ä½ åªéœ€è¦è¾“å‡ºè§£æåçš„Dictï¼Œä¸éœ€è¦è¾“å‡ºå…¶ä»–å†…å®¹ã€‚"""

output = llm.generate_with_parse(query=question, parse_fun=udf_parse,)

print(llm.parse_info)
print(f"è§£æåæ•°æ®ç±»å‹: {type(output[0])}")
print(f"è§£æç»“æœ: {output[0]}")
```

> è¾“å‡ºç»“æœ

```text
[ParseInfo(content="{'name': 'å¼ ä¸‰', 'place': 'æ­å·'}", parsed_data=[{'name': 'å¼ ä¸‰', 'place': 'æ­å·'}], error_message=None)]
è§£æåæ•°æ®ç±»å‹: <class 'dict'>
è§£æç»“æœ: {'name': 'å¼ ä¸‰', 'place': 'æ­å·'}
```

**Tips-1**: *`stream=True`çš„æµå¼è¾“å‡ºæ¨¡å¼ä¸‹ç¦ç”¨äº†ç»“æœè§£æ*
**Tips-2**: *å…¶ä»–è§£ææ–¹å¼è¯·å‚è€ƒ`parse`ç›¸å…³æ–‡æ¡£å†…å®¹*

## å¼‚æ­¥ç”Ÿæˆå›ç­”ç»“æœ

åœ¨æ•°æ®é‡è¾ƒå¤šçš„æ—¶å€™ï¼Œä¹Ÿè®¸æˆ‘ä»¬å¸Œæœ›å¯ä»¥åˆ†å¸ƒå¼çš„è°ƒç”¨æ¨¡å‹ï¼Œè®©æ¨¡å‹åŒæ—¶å¯ä»¥å¤„ç†å¤šæ¡é—®ç­”ã€‚

### å¼‚æ­¥è°ƒç”¨`async_generate`

> ç‰¹æ®Šå‚æ•°ï¼š

- `async_max_request_time`: å¼‚æ­¥è°ƒç”¨æ—¶`async_generate`ä¼šæ¯éš”`1s`æŸ¥è¯¢å›ç­”æ˜¯å¦å®Œæˆï¼Œé»˜è®¤ä¸º`600`sï¼Œå¦‚æœå›ç­”è¶…æ—¶ï¼Œåˆ™è¿”å›`None`ã€‚æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µè®¾å®šè¶…æ—¶æ—¶é—´ã€‚

> è°ƒç”¨ç¤ºä¾‹

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo

llm = Zhipu(generate_config=ZhipuGLM3Turbo())

question_1 = """
æ–‡æœ¬ï¼šå¼ ä¸‰åœ¨æ­å·åƒäº†ä¸€ç¬¼å°ç¬¼åŒ…ã€‚
é—®é¢˜ï¼šè¯·è§£æå‡ºæ–‡æœ¬ä¸­çš„äººåã€åœ°ç‚¹ï¼Œä»¥Dictçš„æ ¼å¼è¾“å‡ºã€‚
æ ¼å¼ç¤ºä¾‹ï¼š{'name': ..., 'place': ...,}
ä½ åªéœ€è¦è¾“å‡ºè§£æåçš„Dictï¼Œä¸éœ€è¦è¾“å‡ºå…¶ä»–å†…å®¹ã€‚"""

question_2 = """
æ–‡æœ¬ï¼šæå››åœ¨ä¸Šæµ·åƒäº†ä¸€ç¬¼å°ç…åŒ…ã€‚
é—®é¢˜ï¼šè¯·è§£æå‡ºæ–‡æœ¬ä¸­çš„äººåã€åœ°ç‚¹ï¼Œä»¥Dictçš„æ ¼å¼è¾“å‡ºã€‚
æ ¼å¼ç¤ºä¾‹ï¼š{'name': ..., 'place': ...,}
ä½ åªéœ€è¦è¾“å‡ºè§£æåçš„Dictï¼Œä¸éœ€è¦è¾“å‡ºå…¶ä»–å†…å®¹ã€‚"""

output = llm.async_generate(query_list=[question_1, question_2])

for completion in output:
    content = completion.choices[0].message.content
    print(type(content), content)
```

> è¾“å‡ºç»“æœ

```text
<class 'str'> {'name': 'å¼ ä¸‰', 'place': 'æ­å·'}
<class 'str'> {'name': 'æå››', 'place': 'ä¸Šæµ·'}
```

### å¼‚æ­¥è°ƒç”¨å¹¶è§£æè¾“å‡ºå†…å®¹`async_generate_with_parse`

> ä½¿ç”¨æ–¹å¼-1: ç»™å®š`parse_dict`

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo

llm = Zhipu(generate_config=ZhipuGLM3Turbo())

question_1 = """
æ–‡æœ¬ï¼šå¼ ä¸‰åœ¨æ­å·åƒäº†ä¸€ç¬¼å°ç¬¼åŒ…ã€‚
é—®é¢˜ï¼šè¯·è§£æå‡ºæ–‡æœ¬ä¸­çš„äººåã€åœ°ç‚¹ï¼Œä»¥Dictçš„æ ¼å¼è¾“å‡ºã€‚
æ ¼å¼ç¤ºä¾‹ï¼š{'name': ..., 'place': ...,}
ä½ åªéœ€è¦è¾“å‡ºè§£æåçš„Dictï¼Œä¸éœ€è¦è¾“å‡ºå…¶ä»–å†…å®¹ã€‚"""

question_2 = """
æ–‡æœ¬ï¼šæå››åœ¨ä¸Šæµ·åƒäº†ä¸€ç¬¼å°ç…åŒ…ã€‚
é—®é¢˜ï¼šè¯·è§£æå‡ºæ–‡æœ¬ä¸­çš„äººåã€åœ°ç‚¹ï¼Œä»¥Dictçš„æ ¼å¼è¾“å‡ºã€‚
æ ¼å¼ç¤ºä¾‹ï¼š{'name': ..., 'place': ...,}
ä½ åªéœ€è¦è¾“å‡ºè§£æåçš„Dictï¼Œä¸éœ€è¦è¾“å‡ºå…¶ä»–å†…å®¹ã€‚"""

outputs = llm.async_generate_with_parse(
    query_list=[question_1, question_2],
    parse_dict="eval",
)

for output in outputs:
    print(type(output), output)
```

> è¾“å‡ºç»“æœ

```text
<class 'list'> [{'name': 'å¼ ä¸‰', 'place': 'æ­å·'}]
<class 'list'> [{'name': 'æå››', 'place': 'ä¸Šæµ·'}]
```

> ä½¿ç”¨æ–¹å¼-2: è‡ªå®šä¹‰è§£æå‡½æ•°ã€‚

```python
from zlai.llms import Zhipu, ZhipuGLM3Turbo

def udf_parse(string):
  """è‡ªå®šä¹‰è§£æå‡½æ•°"""
  return eval(string)

llm = Zhipu(generate_config=ZhipuGLM3Turbo())

question_1 = """
æ–‡æœ¬ï¼šå¼ ä¸‰åœ¨æ­å·åƒäº†ä¸€ç¬¼å°ç¬¼åŒ…ã€‚
é—®é¢˜ï¼šè¯·è§£æå‡ºæ–‡æœ¬ä¸­çš„äººåã€åœ°ç‚¹ï¼Œä»¥Dictçš„æ ¼å¼è¾“å‡ºã€‚
æ ¼å¼ç¤ºä¾‹ï¼š{'name': ..., 'place': ...,}
ä½ åªéœ€è¦è¾“å‡ºè§£æåçš„Dictï¼Œä¸éœ€è¦è¾“å‡ºå…¶ä»–å†…å®¹ã€‚"""

question_2 = """
æ–‡æœ¬ï¼šæå››åœ¨ä¸Šæµ·åƒäº†ä¸€ç¬¼å°ç…åŒ…ã€‚
é—®é¢˜ï¼šè¯·è§£æå‡ºæ–‡æœ¬ä¸­çš„äººåã€åœ°ç‚¹ï¼Œä»¥Dictçš„æ ¼å¼è¾“å‡ºã€‚
æ ¼å¼ç¤ºä¾‹ï¼š{'name': ..., 'place': ...,}
ä½ åªéœ€è¦è¾“å‡ºè§£æåçš„Dictï¼Œä¸éœ€è¦è¾“å‡ºå…¶ä»–å†…å®¹ã€‚"""

outputs = llm.async_generate_with_parse(
    query_list=[question_1, question_2],
    parse_fun=udf_parse,
)

for output in outputs:
    print(type(output), output)
```

> è¾“å‡ºç»“æœ

```text
[ParseInfo(content="{'name': 'å¼ ä¸‰', 'place': 'æ­å·'}", parsed_data=[{'name': 'å¼ ä¸‰', 'place': 'æ­å·'}], error_message=None)]
è§£æåæ•°æ®ç±»å‹: <class 'dict'>
è§£æç»“æœ: {'name': 'å¼ ä¸‰', 'place': 'æ­å·'}
```

**Tips**: *ç›®å‰ï¼Œä»…`æ™ºè°±AI`æ”¯æŒå¼‚æ­¥è°ƒç”¨æ¨¡å¼ã€‚*

## 4. å…¶ä»–

**æ³¨æ„ï¼š**

1. åœ¨åšè§£æç±»ä»»åŠ¡æ—¶ï¼Œ`top_p`å’Œ`temperature`å¯ä»¥è®¾ç½®ç›¸å¯¹è¾ƒä½çš„å€¼ï¼Œä»¥å‡å°‘ç”Ÿæˆç»“æœçš„éšæœºæ€§ã€‚
2. å°†è®¾ç½®`do_sample=True`ï¼Œä»¥è·å–å¯é‡å¤çš„ç»“æœã€‚åœ¨è®¾ç½®`do_sample=False`åï¼Œ`top_p`å’Œ`temperature`å°†ä¸èµ·ä½œç”¨ã€‚

# End

@ 2024/04/28
